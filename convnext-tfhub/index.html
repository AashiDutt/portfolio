<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Publishing ConvNeXt Models on TensorFlow Hub | Sayak Paul</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Publishing ConvNeXt Models on TensorFlow Hub" />
<meta name="author" content="Sayak Paul" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub." />
<meta property="og:description" content="Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub." />
<link rel="canonical" href="https://sayak.dev/convnext-tfhub/" />
<meta property="og:url" content="https://sayak.dev/convnext-tfhub/" />
<meta property="og:site_name" content="Sayak Paul" />
<meta property="og:image" content="https://sayak.dev/images/convnext_tfhub/convnext_header.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-03T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Sayak Paul"},"description":"Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub.","@type":"BlogPosting","headline":"Publishing ConvNeXt Models on TensorFlow Hub","dateModified":"2022-02-03T00:00:00-06:00","datePublished":"2022-02-03T00:00:00-06:00","url":"https://sayak.dev/convnext-tfhub/","mainEntityOfPage":{"@type":"WebPage","@id":"https://sayak.dev/convnext-tfhub/"},"image":"https://sayak.dev/images/convnext_tfhub/convnext_header.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://sayak.dev/feed.xml" title="Sayak Paul" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-163448909-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Publishing ConvNeXt Models on TensorFlow Hub | Sayak Paul</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Publishing ConvNeXt Models on TensorFlow Hub" />
<meta name="author" content="Sayak Paul" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub." />
<meta property="og:description" content="Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub." />
<link rel="canonical" href="https://sayak.dev/convnext-tfhub/" />
<meta property="og:url" content="https://sayak.dev/convnext-tfhub/" />
<meta property="og:site_name" content="Sayak Paul" />
<meta property="og:image" content="https://sayak.dev/images/convnext_tfhub/convnext_header.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-03T00:00:00-06:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Sayak Paul"},"description":"Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub.","@type":"BlogPosting","headline":"Publishing ConvNeXt Models on TensorFlow Hub","dateModified":"2022-02-03T00:00:00-06:00","datePublished":"2022-02-03T00:00:00-06:00","url":"https://sayak.dev/convnext-tfhub/","mainEntityOfPage":{"@type":"WebPage","@id":"https://sayak.dev/convnext-tfhub/"},"image":"https://sayak.dev/images/convnext_tfhub/convnext_header.png","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://sayak.dev/feed.xml" title="Sayak Paul" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-163448909-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Sayak Paul</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/authoring/">Authoring</a><a class="page-link" href="/education/">Education</a><a class="page-link" href="/interviews/">Interviews</a><a class="page-link" href="/research/">Research</a><a class="page-link" href="/talksseminarsworkshops/">Talks/Seminars/Workshops</a><a class="page-link" href="/xyz/">XYZ</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Publishing ConvNeXt Models on TensorFlow Hub</h1><p class="page-description">Converting PyTorch ConvNeXt models to TensorFlow and publishing them on TF-Hub.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-03T00:00:00-06:00" itemprop="datePublished">
        Feb 3, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Sayak Paul</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#tensorflow">tensorflow</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#keras">keras</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#cnns">cnns</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#imagenet-1k">imagenet-1k</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#convnext">convnext</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#About-ConvNeXt">About ConvNeXt </a></li>
<li class="toc-entry toc-h1"><a href="#Implementation-and-weight-porting">Implementation and weight porting </a></li>
<li class="toc-entry toc-h1"><a href="#Validation-of-the-models">Validation of the models </a></li>
<li class="toc-entry toc-h1"><a href="#Publishing-on-TF-Hub">Publishing on TF-Hub </a></li>
<li class="toc-entry toc-h1"><a href="#Wrapping-up">Wrapping up </a></li>
<li class="toc-entry toc-h1"><a href="#Acknowledgements">Acknowledgements </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-02-03-convnext-tfhub.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I recently added 15 different variants of the <a href="https://arxiv.org/abs/2201.03545">ConvNeXt architecture</a> to <a href="https://tfhub.dev/sayakpaul/collections/convnext/1">TensorFlow Hub</a> (TF-Hub). This post is a reflection of what had to be done to get to that point. First, we’ll discuss the implementation of ConvNeXt in Keras and how the original pre-trained parameters were ported into these models. We’ll then talk about TF-Hub’s ConvNeXt collection and what it offers.</p>
<p>I hope this post is useful for anyone willing to contribute models to TF-Hub as doing it the right way can be a good amount of work.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="About-ConvNeXt">
<a class="anchor" href="#About-ConvNeXt" aria-hidden="true"><span class="octicon octicon-link"></span></a>About ConvNeXt<a class="anchor-link" href="#About-ConvNeXt"> </a>
</h1>
<p>ConvNeXt models were proposed by Liu et al. in <a href="https://arxiv.org/abs/2201.03545">A ConvNet for the 2020s</a>. ConvNeXt models are composed of standard layers such as depthwise convolutions, layer normalization, etc., and use standard network topologies. They don’t use self-attention or any hybrid approaches, unlike the recent architectures such as <a href="https://arxiv.org/abs/2010.11929">Vision Transformers</a>, <a href="https://arxiv.org/abs/2106.04803">CoAtNet</a>, etc. The authors start with a base architecture and gradually refine it to match some of the design choices of <a href="https://arxiv.org/abs/2103.14030">Swin Transformers</a>. In the process, they developed a family of models named ConvNeXt achieving performance on the <a href="https://www.image-net.org/">ImageNet-1k dataset</a> with efficiency. For details, check out the <a href="https://arxiv.org/abs/2201.03545">original paper</a>.</p>
<p><img src="https://github.com/sayakpaul/portfolio/raw/master/images/convnext_tfhub/convnext.png" alt=""></p>
<center>
    <b>Figure 1</b>: ConvNeXt performance (source: original paper).
</center>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Implementation-and-weight-porting">
<a class="anchor" href="#Implementation-and-weight-porting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementation and weight porting<a class="anchor-link" href="#Implementation-and-weight-porting"> </a>
</h1>
<p>The ConvNeXt models are fairly easy to implement especially with the <a href="https://github.com/facebookresearch/ConvNeXt">official PyTorch codebase available</a> for reference. As mentioned before, these models can be implemented using the standard components provided in most of the major deep learning frameworks such as JAX, PyTorch, and TensorFlow.</p>
<p>ConvNeXt models use the following block structure with layer scaling as introduced in <a href="https://arxiv.org/abs/2103.17239">Going deeper with image transformers</a> by Touvron et al.</p>
<p><img src="https://github.com/sayakpaul/portfolio/raw/master/images/convnext_tfhub/convnext_block.png" alt=""></p>
<center>
    <b>Figure 2</b>: ConvNeXt block (source: original paper).
</center>
<p>The skip connection is controlled with <a href="https://arxiv.org/abs/1603.09382">Stochastic Depth</a> to induce regularization <em>during</em> training. Different ConvNeXt variants correspond to different depths along with different channels used in each of the stages. For example, the tiny variant uses the following setup:</p>
<div class="highlight"><pre><span></span><span class="n">depths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">96</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">768</span><span class="p">]</span>
</pre></div>
<p>If you plan to populate the implemented models with the original parameters then it helps to align the architecture implementation with the official one as much as possible. Since I went with this approach I tried closely following <a href="https://github.com/facebookresearch/ConvNeXt/blob/main/models/convnext.py">the official implementation</a>. My final implementation is available in <a href="https://github.com/sayakpaul/ConvNeXt-TF/blob/main/models/convnext_tf.py">this script</a>. Note that, it does not yet include the <a href="https://github.com/facebookresearch/ConvNeXt/blob/main/models/convnext_isotropic.py">isotropic ConvNeXt models</a>.</p>
<p>Coming to the weight porting part, this is usually the most interesting part because there’s no standard recipe that’d work for all the models. You’ll need to think about how to best align the original model parameters with your implementation.</p>
<p>A ConvNeXt model is divided into three main parts: (1) stem which directly operates on the input image, (2) downsample blocks that reduce the resolution of feature maps as the network progresses, and (3) stages that apply the ConvNeXt blocks shown above. This is why I organized my weight porting script such that it has a correspondence between these different parts with the original parameters. Here is an example:</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">stem_block</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">):</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">param_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
</pre></div>
<p>The most difficult bit was figuring out how to properly populate the weights of the convolutional layers in TensorFlow from PyTorch. In an earlier implementation, I was simply using transpose(). The resulting models were giving poorer performance than expected. <a href="https://in.linkedin.com/in/vasudevgupta7">Vasudev</a> helped me figure out the correct transposition of the weight axes and the models were then coming out as expected. More about the evaluation of these models in a moment.</p>
<p>Once the weights were ported successfully, the next task was to verify the outputs of the intermediate layers to check if the outputs matched with the original ones. One minor detail to note here is that the outputs of layers are <strong>not</strong> the same as their parameters. So, even if you check if the parameters of your implemented model and the original model are matching, their outputs could still mismatch. This mainly happens because of how certain arguments (<code>use_bias</code> argument in a <a href="https://www.tensorflow.org/api_docs/python/tf/keras/layers/Conv2D">convolutional layer in Keras</a> for example) of certain layers are initialized in different libraries.</p>
<p>The final model conversion script is available <a href="https://github.com/sayakpaul/ConvNeXt-TF/blob/main/convert.py">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Validation-of-the-models">
<a class="anchor" href="#Validation-of-the-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Validation of the models<a class="anchor-link" href="#Validation-of-the-models"> </a>
</h1>
<p>To be more certain, it’s also important to check the evaluation metrics of the converted models on the datasets used during training. In this case, we need to use the top-1 accuracy of the models on the ImageNet-1k dataset (validation set).</p>
<p>To set up this evaluation, I developed <a href="https://github.com/sayakpaul/ConvNeXt-TF/blob/main/i1k_eval/eval.ipynb">this notebook</a> where I closely followed <a href="https://github.com/facebookresearch/ConvNeXt/blob/main/datasets.py">the preprocessing used in the official codebase</a> for inference. The following table reflects the top-1 accuracies of the converted models along with the original scores reported <a href="https://github.com/facebookresearch/ConvNeXt/#results-and-pre-trained-models">here</a>.</p>
<p><style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-c3ow{border-color:inherit;text-align:center;vertical-align:top}
</style></p>
<table class="tg">
<thead>
  <tr>
    <th class="tg-c3ow"><span style="font-weight:bold">Name</span></th>
    <th class="tg-c3ow"><span style="font-weight:bold">Original acc@1</span></th>
    <th class="tg-c3ow"><span style="font-weight:bold">Keras acc@1</span></th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-c3ow">convnext_tiny_1k_224</td>
    <td class="tg-c3ow">82.1</td>
    <td class="tg-c3ow">81.312</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_small_1k_224</td>
    <td class="tg-c3ow">83.1</td>
    <td class="tg-c3ow">82.392</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_base_1k_224</td>
    <td class="tg-c3ow">83.8</td>
    <td class="tg-c3ow">83.28</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_base_1k_384</td>
    <td class="tg-c3ow">85.1</td>
    <td class="tg-c3ow">84.876</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_large_1k_224</td>
    <td class="tg-c3ow">84.3</td>
    <td class="tg-c3ow">83.844</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_large_1k_384</td>
    <td class="tg-c3ow">85.5</td>
    <td class="tg-c3ow">85.376</td>
  </tr>
  <tr>
    <td class="tg-c3ow"></td>
    <td class="tg-c3ow"></td>
    <td class="tg-c3ow"></td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_base_21k_1k_224</td>
    <td class="tg-c3ow">85.8</td>
    <td class="tg-c3ow">85.364</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_base_21k_1k_384</td>
    <td class="tg-c3ow">86.8</td>
    <td class="tg-c3ow">86.79</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_large_21k_1k_224</td>
    <td class="tg-c3ow">86.6</td>
    <td class="tg-c3ow">86.36</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_large_21k_1k_384</td>
    <td class="tg-c3ow">87.5</td>
    <td class="tg-c3ow">87.504</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_xlarge_21k_1k_224</td>
    <td class="tg-c3ow">87.0</td>
    <td class="tg-c3ow">86.732</td>
  </tr>
  <tr>
    <td class="tg-c3ow">convnext_xlarge_21k_1k_384</td>
    <td class="tg-c3ow">87.8</td>
    <td class="tg-c3ow">87.68</td>
  </tr>
</tbody>
</table>
<p>Differences in the results are primarily because of the differences in the library implementations, especially how image resizing is implemented in PyTorch and TensorFlow. My evaluation logs are available at <a href="https://tensorboard.dev/experiment/odN7OPCqQvGYCRpJP1GhRQ/">this URL</a>. I’d like to thank <a href="https://twitter.com/gusthema">Gus</a> from the TF-Hub team for the productive discussions during this phase.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Publishing-on-TF-Hub">
<a class="anchor" href="#Publishing-on-TF-Hub" aria-hidden="true"><span class="octicon octicon-link"></span></a>Publishing on TF-Hub<a class="anchor-link" href="#Publishing-on-TF-Hub"> </a>
</h1>
<p>With the models converted as expected, I was now tasked with publishing them on TF-Hub. These models can be categorized into two different variants: (1) off-the-shelf classifiers and (2) feature extractors used for downstream tasks. This means that the 15 model variants that I had converted would actually amount to 30 models.</p>
<p>Whenever I publish models on TF-Hub, I try to accompany each model with the following:</p>
<ul>
<li>Documentation that includes references of the models, how it was exported, etc.</li>
<li>Colab Notebook showing the model usage. </li>
</ul>
<p>Doing these things (especially the documentation part) for 30 models can be quite cumbersome. <a href="https://www.linkedin.com/in/willi-gierke/">Willi</a> from the TF-Hub team supported me in automatically generating documentation for 30 models. The script is available <a href="https://github.com/sayakpaul/ConvNeXt-TF/blob/main/hub_utilities/generate_doc.py">here</a>. This script was basically generated from a documentation template and can be used for generating documentation when publishing more than one model. Additionally, I worked on a <a href="https://github.com/sayakpaul/ConvNeXt-TF/blob/main/hub_utilities/export_to_hub.py">script</a> that can archive the TensorFlow SavedModels in a way accepted by TF-Hub.</p>
<p>I hope these scripts will be beneficial for anyone planning to contribute models to TF-Hub.</p>
<p>As of today, all 30 models are <a href="https://tfhub.dev/sayakpaul/collections/convnext/1">available on TF-Hub</a>. They come with Colab Notebooks and documentation so that it’s easier to get started. Moreover, these TF-Hub models are not black-box SavedModels. You can load them as <code>tf.keras.Model</code> objects for further inspection. Here’s an example:</p>
<div class="highlight"><pre><span></span><span class="n">model_gcs_path</span> <span class="o">=</span> <span class="s2">"gs://tfhub-modules/sayakpaul/convnext_tiny_1k_224/1/uncompressed"</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">model_gcs_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">expand_nested</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Wrapping-up">
<a class="anchor" href="#Wrapping-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wrapping up<a class="anchor-link" href="#Wrapping-up"> </a>
</h1>
<p>That’s it for the post. We discussed a standard workflow that I use to publish models on TF-Hub and the difficulties that can arise during the process. I hope you’ve found it to be worthy of your time and thank you for reading!</p>
<h1 id="Acknowledgements">
<a class="anchor" href="#Acknowledgements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Acknowledgements<a class="anchor-link" href="#Acknowledgements"> </a>
</h1>
<ul>
<li>
<a href="https://github.com/vasudevgupta7">Vasudev</a> for helping with transposition bug</li>
<li>
<a href="https://twitter.com/gusthema">Gus</a> for fruitful discussions</li>
<li>
<a href="https://www.linkedin.com/in/willi-gierke/">Willi</a> for helping with publishing</li>
<li>
<a href="https://developers.google.com/programs/experts/">ML-GDE program</a> for providing Google Cloud Platform credits</li>
</ul>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="sayakpaul/portfolio"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/convnext-tfhub/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Deep Learning, Computer Vision, etc.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/sayakpaul" target="_blank" title="sayakpaul"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/RisingSayak" target="_blank" title="RisingSayak"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
